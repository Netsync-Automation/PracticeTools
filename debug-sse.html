<!DOCTYPE html>
<html>
<head>
    <title>SSE Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1565c0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>SSE Debug Tool</h1>
    
    <div>
        <button onclick="connectSSE()">Connect SSE</button>
        <button onclick="disconnectSSE()">Disconnect SSE</button>
        <button onclick="testNotification()">Send Test Notification</button>
        <button onclick="checkClients()">Check Connected Clients</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div id="status">Status: Disconnected</div>
    <div id="logs"></div>

    <script>
        let eventSource = null;
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.insertBefore(logDiv, logs.firstChild);
        }
        
        function updateStatus(status) {
            document.getElementById('status').textContent = `Status: ${status}`;
        }
        
        function connectSSE() {
            if (eventSource) {
                log('Already connected', 'error');
                return;
            }
            
            log('Connecting to SSE...', 'info');
            updateStatus('Connecting...');
            
            eventSource = new EventSource('/api/events?issueId=all');
            
            eventSource.onopen = function(event) {
                log('SSE connection opened', 'success');
                updateStatus('Connected');
            };
            
            eventSource.onmessage = function(event) {
                log(`Generic message: ${event.data}`, 'info');
            };
            
            eventSource.onerror = function(event) {
                log(`SSE error: ${JSON.stringify(event)}`, 'error');
                updateStatus('Error');
            };
            
            // Listen for specific events
            eventSource.addEventListener('assignment_created', function(event) {
                log(`üÜï Assignment Created: ${event.data}`, 'success');
            });
            
            eventSource.addEventListener('assignment_updated', function(event) {
                log(`üìù Assignment Updated: ${event.data}`, 'success');
            });
            
            eventSource.addEventListener('connected', function(event) {
                log(`üîó Connected: ${event.data}`, 'success');
            });
            
            eventSource.addEventListener('heartbeat', function(event) {
                log(`üíì Heartbeat: ${event.data}`, 'info');
            });
            
            eventSource.addEventListener('test_message', function(event) {
                log(`üß™ Test Message: ${event.data}`, 'success');
            });
        }
        
        function disconnectSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                log('SSE connection closed', 'info');
                updateStatus('Disconnected');
            } else {
                log('Not connected', 'error');
            }
        }
        
        async function testNotification() {
            try {
                const response = await fetch('/api/test-sse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        channel: 'all', 
                        message: 'Test from debug tool' 
                    })
                });
                const result = await response.json();
                log(`Test notification sent: ${JSON.stringify(result)}`, 'success');
            } catch (error) {
                log(`Error sending test: ${error.message}`, 'error');
            }
        }
        
        async function checkClients() {
            try {
                const response = await fetch('/api/test-sse');
                const result = await response.json();
                log(`Client info: ${JSON.stringify(result, null, 2)}`, 'info');
            } catch (error) {
                log(`Error checking clients: ${error.message}`, 'error');
            }
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        // Auto-connect on page load
        window.onload = function() {
            log('Page loaded, ready to test SSE', 'info');
        };
    </script>
</body>
</html>